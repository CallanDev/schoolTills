<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>School Till System</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family:'Roboto',sans-serif; margin:0; padding:0; background:#f0f2f5; }
header { background:#1e1e2f; color:#fff; padding:15px; text-align:center; font-size:1.5em; }
#loginOverlay, .popup { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:999; }
#loginBox, .popupContent { background:#fff; padding:30px; border-radius:10px; width:400px; max-height:80%; overflow-y:auto; text-align:center; box-shadow:0 0 20px rgba(0,0,0,0.3); }
#loginBox input, #loginBox button, .popupContent input, .popupContent select, .popupContent button { width:80%; padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ccc; }
#loginBox button, .popupContent button { width:auto; background:#1e1e2f; color:#fff; border:none; cursor:pointer; font-weight:700; }
.hidden { display:none; }
#nav { background:#2b2b45; padding:10px; display:flex; gap:10px; }
#nav button { padding:10px 15px; border:none; border-radius:5px; cursor:pointer; background:#4b4b7b; color:#fff; font-weight:600; }
#main { padding:20px; }
.page { display:none; }
.active { display:block; }
#itemsGrid, #backofficeItemsGrid, #parentItemsGrid { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:15px; }
.itemBtn { padding:20px; background:#fff; border:none; border-radius:10px; cursor:pointer; font-size:14px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center; transition:0.2s; position:relative; }
.itemBtn:hover { transform:scale(1.05); background:#e3e3e3; }
.removeBtn { position:absolute; top:5px; right:5px; background:red; color:#fff; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer; }
#basket { margin-top:20px; background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
#basket h3 { margin-top:0; }
.studentEntry, .alert { padding:10px; margin:5px 0; cursor:pointer; border-radius:5px; }
.studentEntry:hover { background:#f0f0f0; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
table, th, td { border:1px solid #ccc; }
th, td { padding:8px; text-align:left; }
th { background:#4b4b7b; color:#fff; }
.draggable { cursor:grab; }
</style>
</head>
<body>
<header>School Till System</header>

<!-- Login Overlay -->
<div id="loginOverlay">
  <div id="loginBox">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red; display:none;">Invalid credentials</p>
  </div>
</div>

<!-- Navigation -->
<div id="nav" class="hidden">
  <button onclick="showPage('till')">Till</button>
  <button onclick="showPage('backoffice')">Back Office</button>
  <button onclick="showPage('parentPreorder')">Parent Pre-Order</button>
  <button onclick="showPage('settings')">Settings</button>
</div>

<!-- Main Pages -->
<div id="main">
  <!-- Till Page -->
  <div id="till" class="page">
    <h2>Till</h2>
    <div>
      <label>Student Name: <input type="text" id="tillStudentName" oninput="checkTillReady()"></label>
      <label>Meal Time: 
        <select id="tillMealTime" onchange="checkTillReady()">
          <option value="">Select</option>
          <option value="Breakfast">Breakfast</option>
          <option value="Break">Break</option>
          <option value="Lunch">Lunch</option>
        </select>
      </label>
      <label>Date: <input type="date" id="tillDate" onchange="checkTillReady()"></label>
      <button onclick="startTillTransaction()">Start Transaction</button>
    </div>
    <div id="itemsGrid"></div>
    <div id="basket">
      <h3>Basket</h3>
      <ul id="basketList"></ul>
      <p>Total: £<span id="basketTotal">0.00</span></p>
      <button onclick="checkoutTill()">Checkout</button>
    </div>
  </div>

  <!-- Back Office Page -->
  <div id="backoffice" class="page">
    <h2>Back Office</h2>
    <button onclick="openBackOffice()">Manage Items & Students</button>
  </div>

  <!-- Parent Pre-Order Page -->
  <div id="parentPreorder" class="page">
    <h2>Parent Pre-Order</h2>
    <label>Student Name: <input type="text" id="parentStudentName" oninput="checkParentReady()"></label>
    <label>Meal Time:
      <select id="parentMealTime" onchange="checkParentReady()">
        <option value="">Select</option>
        <option value="Breakfast">Breakfast</option>
        <option value="Break">Break</option>
        <option value="Lunch">Lunch</option>
      </select>
    </label>
    <label>Date: <input type="date" id="parentDate" onchange="checkParentReady()"></label>
    <div id="parentItemsGrid"></div>
    <div id="parentBasket">
      <h3>Basket</h3>
      <ul id="parentBasketList"></ul>
      <p>Total: £<span id="parentBasketTotal">0.00</span></p>
      <button onclick="confirmParentPreorder()">Confirm Pre-Order</button>
    </div>
  </div>

  <!-- Settings Page -->
  <div id="settings" class="page">
    <h2>Settings</h2>
    <label>Overdraft Limit (£): <input type="number" id="overdraftLimit"></label>
    <label>Daily Cap (£): <input type="number" id="dailyCap"></label>
    <label>Tax Rate (%): <input type="number" id="taxRate"></label>
    <label>Receipt Printing: 
      <select id="receiptPrinting">
        <option value="enabled">Enabled</option>
        <option value="disabled">Disabled</option>
      </select>
    </label>
    <button onclick="saveSettings()">Save Settings</button>
  </div>
</div>

<!-- Popups -->
<div id="popup" class="popup hidden">
  <div class="popupContent" id="popupContent"></div>
</div>

<script>
// ---------- Data ----------
let role=null, basket=[], parentBasket=[], students=[], items=[], parentPreorders={}, settings={overdraft:-10,dailyCap:10,tax:0,receiptPrinting:"enabled"};

// ---------- Utility ----------
function saveAll(){
  localStorage.setItem('students',JSON.stringify(students));
  localStorage.setItem('items',JSON.stringify(items));
  localStorage.setItem('settings',JSON.stringify(settings));
  localStorage.setItem('parentPreorders',JSON.stringify(parentPreorders));
}
function loadAll(){
  students=JSON.parse(localStorage.getItem('students'))||[];
  items=JSON.parse(localStorage.getItem('items'))||[];
  settings=JSON.parse(localStorage.getItem('settings'))||settings;
  parentPreorders=JSON.parse(localStorage.getItem('parentPreorders'))||{};
}

// ---------- Login ----------
function login(){
  const u=document.getElementById("username").value.trim();
  const p=document.getElementById("password").value.trim();
  if((u==="Cashier"||u==="Admin"||u==="Manager") && p==="Mabelcat1CC!!"){
    role=u; document.getElementById("loginOverlay").style.display="none";
    document.getElementById("nav").classList.remove("hidden");
    showPage('till'); renderTillItems(); renderParentItems();
    document.getElementById("overdraftLimit").value=settings.overdraft;
    document.getElementById("dailyCap").value=settings.dailyCap;
    document.getElementById("taxRate").value=settings.tax;
    document.getElementById("receiptPrinting").value=settings.receiptPrinting;
  } else document.getElementById("loginError").style.display="block";
}

// ---------- Navigation ----------
function showPage(page){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(page).classList.add('active');}

// ---------- Till ----------
function checkTillReady(){
  const name=document.getElementById('tillStudentName').value.trim();
  const meal=document.getElementById('tillMealTime').value;
  const date=document.getElementById('tillDate').value;
  document.querySelectorAll('#itemsGrid .itemBtn').forEach(btn=>btn.disabled=!(name && meal && date));
}
function startTillTransaction(){
  const name=document.getElementById('tillStudentName').value.trim();
  const meal=document.getElementById('tillMealTime').value;
  const date=document.getElementById('tillDate').value;
  const student=students.find(s=>s.name.toLowerCase()===name.toLowerCase());
  if(!student){alert("Student not found"); return;}
  if(parentPreorders[name] && parentPreorders[name][meal]) alert("Pre-ordered. Cannot add items.");  
  updateBasketDisplay();
}
function renderTillItems(){
  const grid=document.getElementById('itemsGrid'); grid.innerHTML="";
  items.forEach((item,i)=>{
    const btn=document.createElement('button'); btn.className='itemBtn'; btn.textContent=`${item.name}\n£${item.price}`;
    btn.onclick=()=>{basket.push(item); updateBasketDisplay();};
    grid.appendChild(btn);
  });
}
function updateBasketDisplay(){
  const list=document.getElementById('basketList'); list.innerHTML=""; let total=0;
  basket.forEach((item,i)=>{
    total+=item.price;
    const li=document.createElement('li'); li.textContent=`${item.name} £${item.price.toFixed(2)}`;
    const removeBtn=document.createElement('button'); removeBtn.className="removeBtn"; removeBtn.textContent="x";
    removeBtn.onclick=()=>{basket.splice(i,1); updateBasketDisplay();};
    li.appendChild(removeBtn);
    list.appendChild(li);
  });
  document.getElementById('basketTotal').textContent=total.toFixed(2);
}
function checkoutTill(){
  const name=document.getElementById('tillStudentName').value.trim();
  const meal=document.getElementById('tillMealTime').value;
  const date=document.getElementById('tillDate').value;
  const student=students.find(s=>s.name.toLowerCase()===name.toLowerCase());
  if(!student) return;
  let total=basket.reduce((a,i)=>a+i.price,0);
  total+=total*(settings.tax/100);
  if(student.noSchoolFood && role==="Cashier"){
    showPopup(`<h3>No School Food Authorization</h3>
    <input type="text" id="authUser" placeholder="Admin/Manager Username">
    <input type="password" id="authPass" placeholder="Password">
    <button onclick="authorizeNoSchool('${name}',${total})">Authorize</button>`); return;
  }
  if(student.balance-total<settings.overdraft){alert("Exceeds overdraft"); return;}
  student.balance-=total; basket=[]; updateBasketDisplay(); alert(`Transaction complete. New balance: £${student.balance.toFixed(2)}`); saveAll();
}
function authorizeNoSchool(name,total){
  const u=document.getElementById('authUser').value.trim();
  const p=document.getElementById('authPass').value.trim();
  if((u==="Admin"||u==="Manager") && p==="Mabelcat1CC!!"){
    const student=students.find(s=>s.name===name);
    student.balance-=total; basket=[]; updateBasketDisplay(); alert(`Authorized. Transaction complete. New balance: £${student.balance.toFixed(2)}`); saveAll(); closePopup();
  } else alert("Invalid credentials");
}

// ---------- Parent Pre-Order ----------
function checkParentReady(){
  const name=document.getElementById('parentStudentName').value.trim();
  const meal=document.getElementById('parentMealTime').value;
  const date=document.getElementById('parentDate').value;
  document.querySelectorAll('#parentItemsGrid .itemBtn').forEach(btn=>btn.disabled=!(name && meal && date));
}
function renderParentItems(){
  const grid=document.getElementById('parentItemsGrid'); grid.innerHTML="";
  items.forEach(item=>{
    const btn=document.createElement('button'); btn.className='itemBtn'; btn.textContent=`${item.name}\n£${item.price}`;
    btn.onclick=()=>{
      const name=document.getElementById('parentStudentName').value.trim();
      if(!name) return;
      parentBasket.push(item); updateParentBasketDisplay();
    };
    grid.appendChild(btn);
  });
}
function updateParentBasketDisplay(){
  const list=document.getElementById('parentBasketList'); list.innerHTML=""; let total=0;
  parentBasket.forEach((item,i)=>{
    total+=item.price;
    const li=document.createElement('li'); li.textContent=`${item.name} £${item.price.toFixed(2)}`;
    const removeBtn=document.createElement('button'); removeBtn.className="removeBtn"; removeBtn.textContent="x";
    removeBtn.onclick=()=>{parentBasket.splice(i,1); updateParentBasketDisplay();};
    li.appendChild(removeBtn);
    list.appendChild(li);
  });
  document.getElementById('parentBasketTotal').textContent=total.toFixed(2);
}
function confirmParentPreorder(){
  const name=document.getElementById('parentStudentName').value.trim();
  const meal=document.getElementById('parentMealTime').value;
  const date=document.getElementById('parentDate').value;
  if(!name || !meal || !date){alert("Fill all fields"); return;}
  if(!parentPreorders[name]) parentPreorders[name]={};
  parentPreorders[name][meal]=[...parentBasket]; parentBasket=[]; updateParentBasketDisplay(); saveAll(); alert("Pre-order saved!");
}

// ---------- Back Office & Settings ----------
function saveSettings(){
  settings.overdraft=parseFloat(document.getElementById('overdraftLimit').value)||settings.overdraft;
  settings.dailyCap=parseFloat(document.getElementById('dailyCap').value)||settings.dailyCap;
  settings.tax=parseFloat(document.getElementById('taxRate').value)||settings.tax;
  settings.receiptPrinting=document.getElementById('receiptPrinting').value;
  saveAll(); alert("Settings saved!");
}

// ---------- Popup ----------
function showPopup(html){document.getElementById('popupContent').innerHTML=html; document.getElementById('popup').classList.remove('hidden');}
function closePopup(){document.getElementById('popup').classList.add('hidden');}

// ---------- Initialize ----------
loadAll();
</script>
</body>
</html>
