<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>School Till System</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Roboto',sans-serif; margin:0; padding:0; background:#f0f2f5; }
header { background:#1e1e2f; color:#fff; padding:15px; text-align:center; font-size:1.5em; }
#loginOverlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:999; }
#loginBox { background:#fff; padding:30px; border-radius:10px; width:350px; text-align:center; box-shadow:0 0 20px rgba(0,0,0,0.3); }
#loginBox input, select { width:80%; padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ccc; }
#loginBox button { padding:10px 20px; border:none; border-radius:5px; background:#1e1e2f; color:#fff; cursor:pointer; font-weight:700; }
.hidden { display:none; }
#nav { background:#2b2b45; padding:10px; display:flex; gap:10px; }
#nav button { padding:10px 15px; border:none; border-radius:5px; cursor:pointer; background:#4b4b7b; color:#fff; font-weight:600; }
#main { padding:20px; }
.page { display:none; }
.active { display:block; }
#itemsGrid, #backofficeItemsGrid, #parentItemsGrid { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:15px; }
.itemBtn { padding:20px; background:#fff; border:none; border-radius:10px; cursor:pointer; font-size:14px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center; transition:0.2s; }
.itemBtn:hover { transform:scale(1.05); background:#e3e3e3; }
#basket { margin-top:20px; background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
#basket h3 { margin-top:0; }
.popup { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; z-index:1000; }
.popupContent { background:#fff; padding:20px; border-radius:10px; width:700px; max-height:80%; overflow-y:auto; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
.studentEntry, .alert { padding:10px; margin:5px 0; cursor:pointer; border-radius:5px; }
.studentEntry:hover { background:#f0f0f0; }
.alert { background:#ffefef; color:#b00; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
table, th, td { border:1px solid #ccc; }
th, td { padding:8px; text-align:left; }
th { background:#4b4b7b; color:#fff; }
.draggable { cursor:grab; }
</style>
</head>
<body>
<header>School Till System</header>

<div id="loginOverlay">
  <div id="loginBox">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button id="loginBtn">Login</button>
    <p id="loginError" style="color:red; display:none;">Invalid credentials</p>
  </div>
</div>

<div id="nav" class="hidden">
  <button onclick="showPage('tillPage')">Till</button>
  <button onclick="showPage('backofficePage')">Back Office</button>
  <button onclick="showPage('settingsPage')">Settings</button>
  <button onclick="showPage('parentPage')">Parent Pre-Order</button>
  <button onclick="logout()">Logout</button>
</div>

<div id="main">
  <!-- Till -->
  <div id="tillPage" class="page">
    <h2>Till</h2>
    <label>Meal Time:
      <select id="mealTime">
        <option value="breakfast">Breakfast</option>
        <option value="break">Break</option>
        <option value="lunch">Lunch</option>
      </select>
    </label>
    <div id="selectedStudentInfo"></div>
    <button onclick="startCheckout()">Select/Add Student</button>
    <div id="itemsGrid"></div>
    <div id="basket">
      <h3>Basket</h3>
      <ul id="basketList"></ul>
      <p>Total: £<span id="basketTotal">0.00</span></p>
      <button onclick="confirmTransaction()">Confirm Transaction</button>
    </div>
  </div>

  <!-- Back Office -->
  <div id="backofficePage" class="page">
    <h2>Back Office Management</h2>
    <h3>Menu Items (Drag to reorder)</h3>
    <div id="backofficeItemsGrid"></div>
    <input type="text" id="newItemName" placeholder="Item Name">
    <input type="number" id="newItemPrice" placeholder="Price">
    <input type="text" id="newItemBarcode" placeholder="Barcode">
    <input type="number" id="newItemStock" placeholder="Stock">
    <button onclick="addBackOfficeItem()">Add Item</button>

    <h3>Profiles (Students, Guests, Staff)</h3>
    <table>
      <thead>
        <tr><th>Name</th><th>Type</th><th>Year</th><th>Balance</th><th>No School Food</th><th>Parent Approval</th><th>Allergies</th><th>Actions</th></tr>
      </thead>
      <tbody id="profilesTable"></tbody>
    </table>
    <button onclick="exportProfiles()">Export Profiles</button>
    <button onclick="importProfiles()">Import Profiles</button>
    <button onclick="downloadTemplate()">Download Template</button>
  </div>

  <!-- Settings -->
  <div id="settingsPage" class="page">
    <h2>Settings</h2>
    <label>Overdraft Limit (£):<input type="number" id="overdraftLimit"></label><br>
    <label>Tax Rate (%):<input type="number" id="taxRate"></label><br>
    <label>Daily Spending Cap (£):<input type="number" id="dailyCap"></label><br>
    <label>Receipt Printing:<select id="receiptPrinting">
      <option>Enabled</option><option>Disabled</option></select></label><br>
    <button onclick="saveSettings()">Save Settings</button>
  </div>

  <!-- Parent Pre-Order -->
  <div id="parentPage" class="page">
    <h2>Parent Pre-Order</h2>
    <label>Full Student Name: <input type="text" id="parentStudentName"></label>
    <label>Meal Time:
      <select id="parentMealTime">
        <option value="breakfast">Breakfast</option>
        <option value="break">Break</option>
        <option value="lunch">Lunch</option>
      </select>
    </label>
    <div id="parentItemsGrid"></div>
    <div id="parentBasket">
      <h3>Pre-Order Basket</h3>
      <ul id="parentBasketList"></ul>
      <p>Total: £<span id="parentBasketTotal">0.00</span></p>
      <button onclick="confirmParentPreorder()">Confirm Pre-Order</button>
    </div>
  </div>
</div>

<script>
/************ Data & Initialization ************/
let role = null;
let students = JSON.parse(localStorage.getItem('students')) || [
  {name:"Alice Smith", type:"Student", year:"S1", balance:20, noSchoolFood:false, parentApproval:false, allergies:"Peanuts"},
  {name:"Bob Jones", type:"Student", year:"S2", balance:5, noSchoolFood:true, parentApproval:false, allergies:"None"},
  {name:"Charlie Brown", type:"Guest", year:"", balance:0, noSchoolFood:false, parentApproval:true, allergies:"Gluten"}
];
let items = JSON.parse(localStorage.getItem('items')) || [
  {code:"100001",name:"Sandwich",price:2.50,stock:10},
  {code:"100002",name:"Juice",price:1.20,stock:20},
  {code:"100003",name:"Snack Bar",price:0.80,stock:15},
  {code:"100004",name:"Salad",price:3.00,stock:5}
];
let basket = [];
let selectedStudent = null;
let parentBasket = [];
let parentPreorders = JSON.parse(localStorage.getItem('parentPreorders')) || {};
let settings = JSON.parse(localStorage.getItem('settings')) || {overdraft:-10, tax:0, dailyCap:10, receiptPrinting:"Enabled"};

/************ Login ************/
document.getElementById('loginBtn').addEventListener('click',()=>{
  const u=document.getElementById('username').value.trim();
  const p=document.getElementById('password').value.trim();
  if((u==="Cashier"||u==="Admin"||u==="Manager") && p==="Mabelcat1CC!!"){
    role=u; document.getElementById('loginOverlay').style.display="none"; document.getElementById('nav').classList.remove('hidden');
    showPage('tillPage'); renderTillItems(); renderBackOfficeItems(); renderProfiles(); renderParentItems();
  } else {document.getElementById('loginError').style.display="block";}
});
function logout(){location.reload();}

/************ Page Switching ************/
function showPage(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active');}

/************ Till ************/
function renderTillItems(){
  const grid = document.getElementById('itemsGrid'); grid.innerHTML="";
  items.forEach(item=>{
    const btn = document.createElement('button'); btn.className='itemBtn';
    btn.textContent=`${item.name}\n£${item.price.toFixed(2)}\nStock:${item.stock}`;
    btn.onclick=()=>{if(!selectedStudent){alert("Please select/add a student first."); return;} basket.push(item); updateBasket();}
    grid.appendChild(btn);
  });
}
function updateBasket(){
  const list = document.getElementById('basketList'); list.innerHTML=""; let total=0;
  basket.forEach(i=>{total+=i.price; const li=document.createElement('li'); li.textContent=`${i.name} £${i.price.toFixed(2)}`; list.appendChild(li);});
  if(settings.tax>0) total+=total*(settings.tax/100);
  document.getElementById('basketTotal').textContent=total.toFixed(2);
}
function startCheckout(){
  const name = prompt("Enter full student name:").trim();
  if(!name) return;
  selectedStudent = students.find(s=>s.name.toLowerCase()===name.toLowerCase());
  if(!selectedStudent){alert("Student not found!"); return;}
  document.getElementById('selectedStudentInfo').innerHTML = `Name: ${selectedStudent.name} | Allergies: ${selectedStudent.allergies} | Balance: £${selectedStudent.balance.toFixed(2)}`;
  if(selectedStudent.noSchoolFood){
    const approveBtn = document.createElement('button'); approveBtn.textContent="Enter Admin Code to Override No School Food";
    approveBtn.onclick=()=>{const code = prompt("Enter Admin/Manager Password:"); if(code==="Mabelcat1CC!!"){alert("Approved!"); selectedStudent.noSchoolFood=false;} else alert("Incorrect code.");};
    document.getElementById('selectedStudentInfo').appendChild(approveBtn);
  }
  // Pre-orders
  const meal = document.getElementById('mealTime').value;
  if(parentPreorders[selectedStudent.name] && parentPreorders[selectedStudent.name][meal]){
    alert("This student has pre-ordered: "+parentPreorders[selectedStudent.name][meal].map(i=>i.name).join(", "));
    basket = [...parentPreorders[selectedStudent.name][meal]];
    updateBasket();
  }
}
function confirmTransaction(){
  if(!selectedStudent){alert("Select a student first."); return;}
  const total = basket.reduce((a,i)=>a+i.price,0);
  if(selectedStudent.balance - total < settings.overdraft){alert("Transaction exceeds overdraft limit."); return;}
  selectedStudent.balance-=total;
  alert(`Transaction complete for ${selectedStudent.name}. New balance: £${selectedStudent.balance.toFixed(2)}`);
  basket=[]; updateBasket(); selectedStudent=null; document.getElementById('selectedStudentInfo').innerHTML="";
  saveAll();
}

/************ Back Office ************/
function renderBackOfficeItems(){
  const grid=document.getElementById('backofficeItemsGrid'); grid.innerHTML="";
  items.forEach((item,i)=>{
    const btn = document.createElement('div'); btn.className='itemBtn draggable';
    btn.textContent=`${item.name}\n£${item.price}\nStock:${item.stock}`;
    btn.draggable=true;
    btn.ondragstart=(e)=>{e.dataTransfer.setData('text/plain',i);}
    btn.ondragover=(e)=>{e.preventDefault();}
    btn.ondrop=(e)=>{const from=i; const to=parseInt(e.dataTransfer.getData('text/plain')); [items[from],items[to]]=[items[to],items[from]]; renderBackOfficeItems(); renderTillItems(); renderParentItems(); saveAll();}
    grid.appendChild(btn);
  });
}
function addBackOfficeItem(){
  const name=document.getElementById('newItemName').value;
  const price=parseFloat(document.getElementById('newItemPrice').value);
  const barcode=document.getElementById('newItemBarcode').value;
  const stock=parseInt(document.getElementById('newItemStock').value);
  if(!name||isNaN(price)) return alert("Name and price required.");
  items.push({code:barcode||Math.random().toString(36).substr(2,6), name, price, stock});
  renderBackOfficeItems(); renderTillItems(); renderParentItems(); saveAll();
}

/************ Profiles ************/
function renderProfiles(){
  const tbody=document.getElementById('profilesTable'); tbody.innerHTML="";
  students.forEach((s,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.name}</td><td>${s.type}</td><td>${s.year}</td><td>£${s.balance}</td>
      <td>${s.noSchoolFood}</td><td>${s.parentApproval}</td><td>${s.allergies}</td>
      <td><button onclick="editProfile(${i})">Edit</button> <button onclick="deleteProfile(${i})">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}
function editProfile(i){
  const s=students[i];
  const name=prompt("Name:",s.name); if(!name) return;
  const type=prompt("Type:",s.type); if(!type) return;
  const year=prompt("Year:",s.year);
  const balance=parseFloat(prompt("Balance:",s.balance));
  const noFood=confirm("No School Food?"); const parentApproval=confirm("Parent Approval?");
  const allergies=prompt("Allergies:",s.allergies);
  students[i]={name,type,year,balance,noSchoolFood:noFood,parentApproval:parentApproval,allergies};
  renderProfiles(); saveAll(); renderTillItems(); renderParentItems();
}
function deleteProfile(i){if(confirm("Delete this profile?")){students.splice(i,1); renderProfiles(); saveAll();}}

/************ Parent Pre-Order ************/
function renderParentItems(){
  const grid=document.getElementById('parentItemsGrid'); grid.innerHTML="";
  items.forEach(item=>{
    const btn=document.createElement('button'); btn.className='itemBtn';
    btn.textContent=`${item.name}\n£${item.price}\nStock:${item.stock}`;
    btn.onclick=()=>{const name=document.getElementById('parentStudentName').value.trim(); if(!name){alert("Enter full student name."); return;} parentBasket.push(item); updateParentBasket();}
    grid.appendChild(btn);
  });
}
function updateParentBasket(){
  const list=document.getElementById('parentBasketList'); list.innerHTML=""; let total=0;
  parentBasket.forEach(i=>{total+=i.price; const li=document.createElement('li'); li.textContent=`${i.name} £${i.price.toFixed(2)}`; list.appendChild(li);});
  document.getElementById('parentBasketTotal').textContent=total.toFixed(2);
}
function confirmParentPreorder(){
  const name=document.getElementById('parentStudentName').value.trim();
  if(!name) return alert("Enter student name.");
  const meal=document.getElementById('parentMealTime').value;
  if(!parentPreorders[name]) parentPreorders[name]={};
  parentPreorders[name][meal]=[...parentBasket];
  parentBasket=[]; updateParentBasket(); alert("Pre-order saved."); saveAll();
}

/************ Settings ************/
function saveSettings(){
  settings.overdraft=parseFloat(document.getElementById('overdraftLimit').value)||settings.overdraft;
  settings.tax=parseFloat(document.getElementById('taxRate').value)||settings.tax;
  settings.dailyCap=parseFloat(document.getElementById('dailyCap').value)||settings.dailyCap;
  settings.receiptPrinting=document.getElementById('receiptPrinting').value;
  alert("Settings saved."); saveAll();
}

/************ Import/Export ************/
function exportProfiles(){const data=JSON.stringify(students,null,2); const blob=new Blob([data],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="profiles.json"; a.click();}
function importProfiles(){const input=document.createElement('input'); input.type='file'; input.accept='.json'; input.onchange=e=>{const file=e.target.files[0]; const reader=new FileReader(); reader.onload=function(ev){students=JSON.parse(ev.target.result); renderProfiles(); saveAll();}; reader.readAsText(file);}; input.click();}
function downloadTemplate(){const data=JSON.stringify([{name:"Full Name",type:"Student",year:"S1",balance:0,noSchoolFood:false,parentApproval:false,allergies:""}],null,2); const blob=new Blob([data],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="template.json"; a.click();}

/************ Persistence ************/
function saveAll(){
  localStorage.setItem('students',JSON.stringify(students));
  localStorage.setItem('items',JSON.stringify(items));
  localStorage.setItem('parentPreorders',JSON.stringify(parentPreorders));
  localStorage.setItem('settings',JSON.stringify(settings));
}
window.addEventListener('beforeunload',saveAll);

</script>
</body>
</html>
