<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>School Till System</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family:'Roboto',sans-serif; margin:0; padding:0; background:#f0f2f5; }
header { background:#1e1e2f; color:#fff; padding:15px; text-align:center; font-size:1.5em; }
#loginOverlay, .popup { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:999; }
#loginBox, .popupContent { background:#fff; padding:30px; border-radius:10px; width:500px; max-height:80%; overflow-y:auto; text-align:center; box-shadow:0 0 20px rgba(0,0,0,0.3); }
#loginBox input, #loginBox button, .popupContent input, .popupContent select, .popupContent button { width:80%; padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ccc; }
#loginBox button, .popupContent button { width:auto; background:#1e1e2f; color:#fff; border:none; cursor:pointer; font-weight:700; }
.hidden { display:none; }
#nav { background:#2b2b45; padding:10px; display:flex; gap:10px; }
#nav button { padding:10px 15px; border:none; border-radius:5px; cursor:pointer; background:#4b4b7b; color:#fff; font-weight:600; }
#main { padding:20px; }
.page { display:none; }
.active { display:block; }
#itemsGrid, #parentItemsGrid, #backofficeItemsGrid { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:15px; }
.itemBtn { padding:20px; background:#fff; border:none; border-radius:10px; cursor:pointer; font-size:14px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center; transition:0.2s; position:relative; }
.itemBtn:hover { transform:scale(1.05); background:#e3e3e3; }
.removeBtn { position:absolute; top:5px; right:5px; background:red; color:#fff; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer; }
#basket, #backofficeTables, #parentBasket { margin-top:20px; background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
#basket h3, #backofficeTables h3 { margin-top:0; }
.studentEntry, .alert { padding:10px; margin:5px 0; cursor:pointer; border-radius:5px; }
.studentEntry:hover { background:#f0f0f0; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
table, th, td { border:1px solid #ccc; }
th, td { padding:8px; text-align:left; }
th { background:#4b4b7b; color:#fff; }
.draggable { cursor:grab; }
</style>
</head>
<body>
<header>School Till System</header>

<!-- Login Overlay -->
<div id="loginOverlay">
  <div id="loginBox">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red; display:none;">Invalid credentials</p>
  </div>
</div>

<!-- Navigation -->
<div id="nav" class="hidden">
  <button onclick="showPage('till')">Till</button>
  <button onclick="showPage('backoffice')">Back Office</button>
  <button onclick="showPage('parentPreorder')">Parent Pre-Order</button>
  <button onclick="showPage('settings')">Settings</button>
</div>

<!-- Main Pages -->
<div id="main">
  <!-- Till Page -->
  <div id="till" class="page">
    <h2>Till</h2>
    <div>
      <label>Student Name: <input type="text" id="tillStudentName" oninput="checkTillReady()"></label>
      <label>Meal Time: 
        <select id="tillMealTime" onchange="checkTillReady()">
          <option value="">Select</option>
          <option value="Breakfast">Breakfast</option>
          <option value="Break">Break</option>
          <option value="Lunch">Lunch</option>
        </select>
      </label>
      <label>Date: <input type="date" id="tillDate" onchange="checkTillReady()"></label>
      <button id="startTransactionBtn" onclick="startTillTransaction()" disabled>Start Transaction</button>
    </div>
    <div id="itemsGrid"></div>
    <div id="basket">
      <h3>Basket</h3>
      <ul id="basketList"></ul>
      <p>Total: £<span id="basketTotal">0.00</span></p>
      <button onclick="checkoutTill()">Checkout</button>
    </div>
  </div>

  <!-- Back Office Page -->
  <div id="backoffice" class="page">
    <h2>Back Office</h2>
    <div id="backofficeTables">
      <h3>Items</h3>
      <button onclick="openItemPopup()">Add Item</button>
      <button onclick="exportItemsCSV()">Export Items CSV</button>
      <button onclick="exportItemsPDF()">Export Items PDF</button>
      <input type="file" id="importItemsFile" onchange="importItemsCSV(event)">
      <table id="itemsTable"><thead><tr><th>Code</th><th>Name</th><th>Price</th><th>Stock</th><th>Actions</th></tr></thead><tbody></tbody></table>
      <h3>Students</h3>
      <button onclick="openStudentPopup()">Add Student</button>
      <button onclick="exportStudentsCSV()">Export Students CSV</button>
      <button onclick="exportStudentsPDF()">Export Students PDF</button>
      <input type="file" id="importStudentsFile" onchange="importStudentsCSV(event)">
      <table id="studentsTable"><thead><tr><th>Name</th><th>Type</th><th>Year</th><th>Balance</th><th>No School Food</th><th>Parent Approval</th><th>Actions</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- Parent Pre-Order Page -->
  <div id="parentPreorder" class="page">
    <h2>Parent Pre-Order</h2>
    <label>Student Name: <input type="text" id="parentStudentName" oninput="checkParentReady()"></label>
    <label>Meal Time:
      <select id="parentMealTime" onchange="checkParentReady()">
        <option value="">Select</option>
        <option value="Breakfast">Breakfast</option>
        <option value="Break">Break</option>
        <option value="Lunch">Lunch</option>
      </select>
    </label>
    <label>Date: <input type="date" id="parentDate" onchange="checkParentReady()"></label>
    <div id="parentItemsGrid"></div>
    <div id="parentBasket">
      <h3>Basket</h3>
      <ul id="parentBasketList"></ul>
      <p>Total: £<span id="parentBasketTotal">0.00</span></p>
      <button onclick="confirmParentPreorder()">Confirm Pre-Order</button>
    </div>
  </div>

  <!-- Settings Page -->
  <div id="settings" class="page">
    <h2>Settings</h2>
    <label>Overdraft Limit (£): <input type="number" id="overdraftLimit"></label>
    <label>Daily Cap (£): <input type="number" id="dailyCap"></label>
    <label>Tax Rate (%): <input type="number" id="taxRate"></label>
    <label>Receipt Printing: 
      <select id="receiptPrinting">
        <option value="enabled">Enabled</option>
        <option value="disabled">Disabled</option>
      </select>
    </label>
    <button onclick="saveSettings()">Save Settings</button>
  </div>
</div>

<!-- Generic Popup -->
<div id="popup" class="popup hidden">
  <div class="popupContent" id="popupContent"></div>
</div>

<script>
// ---------- Data & Persistence ----------
let role=null, basket=[], parentBasket=[];
let students=[], items=[], parentPreorders={}, settings={overdraft:-10,dailyCap:10,tax:0,receiptPrinting:"enabled"};

function saveAll(){localStorage.setItem('students',JSON.stringify(students)); localStorage.setItem('items',JSON.stringify(items)); localStorage.setItem('settings',JSON.stringify(settings)); localStorage.setItem('parentPreorders',JSON.stringify(parentPreorders));}
function loadAll(){students=JSON.parse(localStorage.getItem('students'))||[]; items=JSON.parse(localStorage.getItem('items'))||[]; settings=JSON.parse(localStorage.getItem('settings'))||settings; parentPreorders=JSON.parse(localStorage.getItem('parentPreorders'))||{};}

// ---------- Login ----------
function login(){
  const u=document.getElementById("username").value.trim();
  const p=document.getElementById("password").value.trim();
  if((u==="Cashier"||u==="Admin"||u==="Manager") && p==="Mabelcat1CC!!"){
    role=u;
    document.getElementById("loginOverlay").style.display="none";
    document.getElementById("nav").classList.remove("hidden");
    showPage('till');
    renderItems(); renderBackOffice(); renderParentItems(); loadSettings();
  } else document.getElementById("loginError").style.display="block";
}

// ---------- Page Switching ----------
function showPage(page){['till','backoffice','parentPreorder','settings'].forEach(p=>document.getElementById(p).classList.remove('active')); document.getElementById(page).classList.add('active');}

// ---------- Core Functions Placeholder ----------
// Here you would implement all: rendering items, back office tables, popups for add/edit, till basket logic, parent preorder logic, CSV/PDF export, admin overrides, cross-removal, localStorage saving, and validation.

loadAll();
</script>
</body>
</html>
